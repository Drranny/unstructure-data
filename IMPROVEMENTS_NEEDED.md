# 기능 스캔 결과 및 보강 필요 사항

## 🔍 발견된 문제점 및 개선 필요 사항

### 1. ⚠️ **데이터 구조 불일치 문제**

#### 문제 1-1: `all_scores`에 사용되지 않는 키 존재
**위치**: `src/dataset_analyzer.py:44-48`
```python
all_scores = {
    "해상도": [],
    "유효성": [],
    "중복도": [],  # ⚠️ 사용되지 않음 (이미지 분석에서)
    "종합점수": []
}
```
**문제**: 이미지 분석에서 `all_scores["중복도"]`에 값을 추가하는 코드가 없음
**영향**: 메모리 낭비, 코드 혼란
**해결 필요**: 사용하지 않는 키 제거 또는 주석 명확화

---

#### 문제 1-2: 텍스트 개별 점수 키 이름 불일치
**위치**: `src/dataset_analyzer.py:188-193`, `src/utils.py:545-546`
**상태**: ✅ **해결 완료**
**해결 내용**: 키 이름을 "형식 정확성", "다양성"으로 통일

---

### 2. ⚠️ **로직 불일치 문제**

#### 문제 2-1: 이미지 분석에서 `is_single_image` 파라미터 미사용
**위치**: `src/dataset_analyzer.py:63`
```python
# 개별 이미지 분석 시에는 항상 is_single_image=True로 호출 (다양성 제외)
scores = analyze_image_quality(img, is_single_image=True)
```
**문제**: 배치 분석이어도 개별 이미지 점수 계산 시 항상 `is_single_image=True`로 고정
**현재 동작**: 의도한 대로 동작 (개별 점수에는 다양성 제외)
**확인 필요**: 이 로직이 의도한 것인지 확인 필요

---

#### 문제 2-2: `image_quality.py`에서 사용되지 않는 로직
**위치**: `src/image_quality.py:50-54`
```python
if is_single_image:
    duplication_score = None 
else:
    # 배치 루프에서 호출되는 경우
    duplication_score = 1.0  # ⚠️ 항상 1.0 반환 (의미 없음)
```
**문제**: `is_single_image=False`일 때 항상 1.0을 반환하는데, 이 값은 사용되지 않음
**영향**: 불필요한 계산, 코드 혼란
**해결 필요**: 이 분기 로직 정리 또는 제거

---

### 3. ⚠️ **에러 처리 부족**

#### 문제 3-1: 개별 점수 접근 시 인덱스 오류 가능성
**위치**: `app.py:290`
**상태**: ✅ **해결 완료**
**해결 내용**: 안전한 접근 로직 추가 (`individual_scores[0] if individual_scores else {}`)

---

#### 문제 3-2: 데이터프레임 정렬 시 존재하지 않는 컬럼 참조 가능
**위치**: `app.py:1192`
**상태**: ✅ **해결 완료**
**해결 내용**: 컬럼 존재 여부 확인 후 정렬 (`if sort_by in df_scores.columns:`)

---

#### 문제 3-3: Hugging Face 데이터셋 로드 실패 시 부분적 에러 처리
**위치**: `src/dataset_analyzer.py:534-555`
**문제**: 일부 예외는 처리하지만, 최종적으로 `dataset`이 None일 수 있는 경우 처리 부족
**영향**: None 체크 없이 사용 시 AttributeError 발생 가능
**해결 필요**: None 체크 강화

---

### 4. ⚠️ **데이터 검증 부족**

#### 문제 4-1: 텍스트 다양성 계산 시 빈 문장 리스트 처리
**위치**: `src/text_quality.py:430-436`
```python
def check_text_duplication(sentences: list) -> float:
    if len(sentences) < 2:
        return 1.0  # 문장이 하나면 중복 없음
```
**문제**: 문장이 0개일 때도 1.0 반환 (의미 없음)
**영향**: 빈 텍스트에 대해 잘못된 점수 반환
**해결 필요**: 빈 텍스트 케이스 명시적 처리

---

#### 문제 4-2: 이미지 해시 계산 실패 시 처리 부족
**위치**: `src/dataset_analyzer.py:85`
```python
image_hashes.append(imagehash.average_hash(img))
```
**문제**: 이미지가 손상되었거나 특수한 형식일 경우 예외 발생 가능
**영향**: 전체 배치 분석 실패
**해결 필요**: try-except로 개별 이미지 실패 시 스킵 처리

---

### 5. ⚠️ **UI 일관성 문제**

#### 문제 5-1: 텍스트 개별 점수 표시 시 키 이름 불일치
**위치**: `app.py:1297`, `src/utils.py:545-546`
**상태**: ✅ **해결 완료**
**해결 내용**: 키 이름을 "형식 정확성", "다양성"으로 통일

---

#### 문제 5-2: 개별 점수 데이터프레임 컬럼명 불일치
**위치**: `app.py:1180`, `src/utils.py:525-526`
**상태**: ✅ **해결 완료**
**해결 내용**: 컬럼명을 "형식 정확성", "다양성", "완전성"으로 통일

---

### 6. ⚠️ **성능 및 최적화 문제**

#### 문제 6-1: 대용량 데이터셋 처리 시 메모리 사용량
**위치**: `src/dataset_analyzer.py:60-78`
**문제**: 모든 이미지를 메모리에 로드하여 처리
**영향**: 대용량 데이터셋(수천 개) 처리 시 메모리 부족 가능
**해결 필요**: 배치 처리 또는 스트리밍 방식 고려

---

#### 문제 6-2: Sentence Transformer 모델 반복 로드 가능성
**위치**: `src/text_quality.py:36-50`
**문제**: 싱글톤 패턴 사용 중이지만, 예외 발생 시 재로드 가능
**영향**: 불필요한 모델 재로드로 인한 지연
**해결 필요**: 예외 처리 강화

---

### 7. ⚠️ **라벨링 기반 평가 모듈 문제**

#### 문제 7-1: 선택적 의존성 오류 처리 부족
**위치**: `src/quality_evaluator.py:10-44`
**문제**: 패키지가 없을 때 경고만 출력하고 계속 진행하지만, 실제 사용 시 오류 발생
**영향**: 런타임 오류 발생 가능
**해결 필요**: 각 함수에서 패키지 존재 여부 확인 후 사용

---

#### 문제 7-2: CSV/JSON 파싱 오류 처리 부족
**위치**: `app.py:1390-1405`
**문제**: 파일 형식이 잘못되었거나 인코딩 문제 시 처리 부족
**영향**: 프로그램 크래시 가능
**해결 필요**: try-except로 파싱 오류 처리

---

#### 문제 7-3: 컬럼 매핑 검증 부족
**위치**: `app.py:1411-1423`
**문제**: 사용자가 선택한 컬럼이 실제로 존재하는지, 데이터 타입이 맞는지 검증 부족
**영향**: 잘못된 컬럼 선택 시 런타임 오류
**해결 필요**: 컬럼 존재 여부 및 데이터 타입 검증

---

### 8. ⚠️ **데이터 일관성 문제**

#### 문제 8-1: 텍스트 개별 점수 키 이름 통일 필요
**현재 상태**:
- 저장: `"정확성"`, `"중복도"`, `"완전성"`
- 표시: `"형식 정확성"`, `"다양성"`, `"완전성"`

**해결 필요**: 
- 옵션 1: 저장 시 키 이름을 "형식 정확성", "다양성"으로 변경
- 옵션 2: 표시 시 매핑 딕셔너리 사용

---

#### 문제 8-2: 이미지 개별 점수에 다양성 키가 없는지 확인 필요
**위치**: `src/dataset_analyzer.py:74-78`
**현재**: 개별 점수에 다양성 제외 ✅
**확인 필요**: UI에서 다양성 컬럼을 참조하는 코드가 남아있는지 확인

---

### 9. ⚠️ **문서화 및 주석 문제**

#### 문제 9-1: 함수 docstring 불일치
**위치**: `src/image_quality.py:10-19`
```python
def analyze_image_quality(img: Image.Image, is_single_image: bool = False):
    """
    이미지 품질을 분석하여 지표를 반환합니다.
    
    Args:
        img: PIL Image 객체
        # ⚠️ is_single_image 파라미터 설명 누락
        
    Returns:
        dict: 품질 지표 딕셔너리
    """
```
**문제**: `is_single_image` 파라미터에 대한 설명 누락
**해결 필요**: docstring 보완

---

### 10. ⚠️ **엣지 케이스 처리 부족**

#### 문제 10-1: 이미지가 1개인 배치 분석
**위치**: `src/dataset_analyzer.py:37, 92`
```python
is_single_image = (len(images) == 1)
...
if not is_single_image and len(image_hashes) > 1:
```
**문제**: 이미지가 1개면 `is_single_image=True`이지만, `image_hashes`도 1개만 있어서 다양성 계산 불가
**현재 동작**: ✅ 정상 (다양성 N/A 처리)
**확인 필요**: 이 케이스가 의도한 대로 처리되는지 확인

---

#### 문제 10-2: 텍스트가 모두 빈 문자열인 경우
**위치**: `src/dataset_analyzer.py:171-173`
```python
if not text or len(text.strip()) == 0:
    continue
```
**문제**: 모든 텍스트가 빈 문자열이면 `all_scores["종합점수"]`가 빈 리스트
**현재 처리**: ✅ 빈 리스트 체크 있음 (195-202줄)
**확인 필요**: 이 케이스에서 반환되는 값이 적절한지 확인

---

## 📋 우선순위별 개선 사항

### 🔴 **높은 우선순위 (즉시 수정 필요)**

1. ✅ **텍스트 개별 점수 키 이름 통일** (문제 1-2, 5-1, 8-1) - **해결 완료**
   - 저장 시 "형식 정확성", "다양성"으로 통일 완료

2. ✅ **개별 점수 접근 시 안전성 강화** (문제 3-1) - **해결 완료**
   - 빈 리스트 체크 추가 완료
   - 인덱스 범위 검증 완료

3. ✅ **데이터프레임 정렬 시 컬럼 존재 여부 확인** (문제 3-2) - **해결 완료**
   - 정렬 전 컬럼 존재 여부 검증 완료

---

### 🟡 **중간 우선순위 (개선 권장)**

4. **사용되지 않는 코드 정리** (문제 1-1, 2-2)
   - `all_scores["중복도"]` 제거 또는 사용 로직 추가
   - `image_quality.py`의 불필요한 분기 정리

5. **에러 처리 강화** (문제 3-3, 4-2)
   - Hugging Face 데이터셋 로드 실패 시 명확한 에러 메시지
   - 이미지 해시 계산 실패 시 스킵 처리

6. **CSV/JSON 파싱 오류 처리** (문제 7-2)
   - 파일 형식 검증
   - 인코딩 오류 처리

---

### 🟢 **낮은 우선순위 (선택적 개선)**

7. **성능 최적화** (문제 6-1, 6-2)
   - 대용량 데이터셋 배치 처리
   - 모델 로드 최적화

8. **문서화 보완** (문제 9-1)
   - 함수 docstring 보완
   - 파라미터 설명 추가

9. **엣지 케이스 처리** (문제 10-1, 10-2)
   - 특수 케이스에 대한 명시적 처리

---

## 🔧 구체적 수정 제안

### 수정 1: 텍스트 개별 점수 키 이름 통일
```python
# src/dataset_analyzer.py:188-193
individual_scores.append({
    "형식 정확성": round(accuracy, 3),  # "정확성" → "형식 정확성"
    "다양성": round(duplication, 3),    # "중복도" → "다양성"
    "완전성": round(completeness, 3),
    "종합점수": round(total, 3),
})
```

### 수정 2: 개별 점수 접근 안전성 강화
```python
# app.py:290
individual_scores = results.get("개별 점수", [])
if individual_scores:
    image_scores = individual_scores[0]
else:
    image_scores = {}
    st.error("분석 결과를 가져올 수 없습니다.")
```

### 수정 3: 데이터프레임 정렬 안전성
```python
# app.py:1192
if sort_by in df_scores.columns:
    df_scores_sorted = df_scores.sort_values(by=sort_by, ascending=ascending)
else:
    st.warning(f"정렬 기준 '{sort_by}'를 찾을 수 없습니다. 기본 정렬을 사용합니다.")
    df_scores_sorted = df_scores
```

---

## 📊 영향도 분석

| 문제 | 심각도 | 영향 범위 | 수정 난이도 |
|------|--------|----------|------------|
| 텍스트 키 이름 불일치 | 🔴 높음 | UI 표시, PDF 보고서 | 낮음 |
| 개별 점수 접근 오류 | 🔴 높음 | 프로그램 크래시 | 낮음 |
| 정렬 컬럼 오류 | 🟡 중간 | 사용자 경험 | 낮음 |
| 사용되지 않는 코드 | 🟢 낮음 | 코드 품질 | 낮음 |
| 에러 처리 부족 | 🟡 중간 | 안정성 | 중간 |
| 성능 최적화 | 🟢 낮음 | 대용량 처리 | 높음 |

---

**작성일**: 2024년  
**스캔 범위**: 전체 코드베이스  
**상태**: 수정 필요 사항 정리 완료

